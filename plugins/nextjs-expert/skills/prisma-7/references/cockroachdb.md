---
name: cockroachdb
description: CockroachDB integration with Prisma 7, distributed database features, and scaling
when-to-use: CockroachDB databases, distributed SQL, scaling requirements, global deployments
keywords: CockroachDB, distributed, PostgreSQL-compatible, scaling, replicas
priority: medium
requires: schema.md, connection-pooling.md, schema.types.md
related: postgresql.md, deployment.md, driver-adapters.md
---

# CockroachDB with Prisma 7

Type definitions in `/plugins/nextjs-expert/skills/prisma-7/references/interfaces/schema.types.md`.

CockroachDB integration and distributed database features in Prisma 7.

## Connection

```env
# .env
DATABASE_URL="postgresql://user:password@localhost:26257/myapp?sslmode=require&schema=public"
```

CockroachDB is PostgreSQL-compatible, so Prisma treats it as PostgreSQL:

```prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

---

## Schema Example

```typescript
/**
 * CockroachDB schema with distributed features.
 * See `ModelDefinition` in /plugins/nextjs-expert/skills/prisma-7/references/interfaces/schema.types.md
 * @typedef {Object} User
 * @property {string} id - UUID primary key generated by database
 * @property {string} email - Unique email address
 * @property {string} name - User name
 * @property {Account | null} account - One-to-one account relation
 * @property {Post[]} posts - One-to-many posts relation
 * @property {Date} createdAt - Timestamp of creation
 * @module modules/database/src/models/user
 */
type User = {
  id: string;
  email: string;
  name: string;
  account: Account | null;
  posts: Post[];
  createdAt: Date;
}

/**
 * Account model for user account relation.
 * @typedef {Object} Account
 * @property {string} id - Primary key
 * @property {string} userId - Foreign key to User
 * @property {User} user - User relation
 * @module modules/database/src/models/account
 */
type Account = {
  id: string;
  userId: string;
  user: User;
}

/**
 * Post model with author relation and indexing.
 * @typedef {Object} Post
 * @property {string} id - Primary key
 * @property {string} title - Post title
 * @property {string} content - Post content
 * @property {boolean} published - Publication status
 * @property {string} authorId - Foreign key to User
 * @property {User} author - Author relation
 * @property {Date} createdAt - Timestamp
 * @module modules/database/src/models/post
 */
type Post = {
  id: string;
  title: string;
  content: string;
  published: boolean;
  authorId: string;
  author: User;
  createdAt: Date;
}
```

---

## Distributed Features

### 1. Multi-Region Setup

```bash
# CockroachDB multi-region cluster
cockroach start --insecure --locality=region=us-east-1 &
cockroach start --insecure --locality=region=us-west-1 &
cockroach start --insecure --locality=region=eu-west-1 &
```

Prisma automatically routes to nearest replica for read-heavy workloads.

### 2. High Availability

CockroachDB replicates across 3 nodes by default:

```sql
ALTER TABLE "User" CONFIGURE ZONE USING
  num_replicas = 3,
  constraints = '["+region=us-east-1"]';
```

---

## Transactions

```typescript
/**
 * Distributed transaction handling with CockroachDB.
 * See `ModelDefinition` in /plugins/nextjs-expert/skills/prisma-7/references/interfaces/schema.types.md
 * @typedef {Object} TransactionResult
 * @property {User} user - Created user
 * @property {Account} account - Created account
 * @module modules/database/src/services/distributed-transactions
 */
type TransactionResult = {
  user: User;
  account: Account;
}

/**
 * Create user with account in distributed transaction.
 * Prisma handles ACID guarantees across CockroachDB replicas.
 * @param {string} email - User email
 * @param {string} name - User name
 * @returns {Promise<TransactionResult>} User and account created in transaction
 * @module modules/database/src/services/users
 */
async function createUserWithAccount(
  email: string,
  name: string
): Promise<TransactionResult> {
  const result = await prisma.$transaction(async (tx) => {
    const user = await tx.user.create({
      data: { email, name },
    })

    const account = await tx.account.create({
      data: { userId: user.id },
    })

    return { user, account }
  })

  // CockroachDB guarantees ACID across replicas
  return result
}
```

---

## Cluster Support

```typescript
/**
 * CockroachDB cluster connection with multiple nodes.
 * @module modules/database/src/config/cockroach
 */

/**
 * Get CockroachDB connection URL with load balancing.
 * Prisma automatically load-balances queries across nodes.
 * @returns {string} Connection string with multiple nodes
 * @module modules/database/src/config/database
 */
function getCockroachDbUrl(): string {
  const nodes = [
    'node1:26257',
    'node2:26257',
    'node3:26257'
  ]
  return `postgresql://user:password@${nodes.join(',')}/myapp?sslmode=require`
}
```

---

## Best Practices

1. **Index foreign keys** - Critical for joins
2. **Use UUIDs** - Better for distributed keys
3. **Avoid hot spots** - Distribute writes
4. **Monitor latency** - Multi-region adds delay
5. **Connection pooling** - Use PgBouncer

---

## Limitations

1. **No full-text search** - Use ILIKE instead
2. **Limited JSONB** - Similar to PostgreSQL
3. **No materialized views** - Use tables instead
4. **No partitioning** - Built-in replication handles it

---

## Example: Global User Service

```typescript
/**
 * CockroachDB Prisma client initialization.
 * @module modules/database/src/client
 */
import { PrismaClient } from '@prisma/client'

/**
 * Initialize Prisma client with logging.
 * CockroachDB handles replication transparently.
 * @returns {PrismaClient} Prisma client instance
 * @module modules/database/src/client
 */
export const prisma = new PrismaClient({
  log: ['query', 'error', 'warn'],
})

/**
 * Get user with posts by ID.
 * @param {string} userId - User identifier
 * @returns {Promise<(User & {posts: Post[]}) | null>} User with posts
 * @module modules/api/users/[id]/route
 */
export async function GET(request: Request, { params }: { params: { id: string } }) {
  const user = await prisma.user.findUnique({
    where: { id: params.id },
    include: { posts: true },
  })

  // CockroachDB handles replication transparently
  return Response.json(user)
}
```

---

## Connection Pooling

```env
DATABASE_URL="postgresql://user:password@cockroachdb:26257/myapp?sslmode=require&statement_cache_size=0"
```

CockroachDB uses cluster connections - Prisma handles pooling via connection string.
